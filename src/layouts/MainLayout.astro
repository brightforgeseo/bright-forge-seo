---
// MainLayout.astro
import SEO from '../components/SEO.astro';

// Standard Astro CSS imports - these should automatically generate link tags
import '../styles/global.css';
import '../styles/case-study-fix.css';
import '../styles/bundled.css';
import '../styles/critical.css';
// Removed breadcrumbs.css - now using inline styles to prevent conflicts
import '../styles/force-black-breadcrumbs.css'; // Global CSS override for black breadcrumb text
import '../styles/red-theme.css';

interface Props {
  title: string;
  description?: string;
  canonical?: string;
  image?: string;
  type?: 'website' | 'article' | 'blog' | 'product' | 'service' | 'profile' | 'company';
  publishDate?: string;
  modifiedDate?: string;
  author?: {
    name: string;
    url?: string;
  };
  article?: {
    tags?: string[];
    section?: string;
  };
  breadcrumbs?: Array<{
    name: string;
    url: string;
  }>;
  noindex?: boolean;
  nofollow?: boolean;
  faqs?: Array<{
    question: string;
    answer: string;
  }>;
}

const { 
  title, 
  description = "Bright Forge SEO Philippines - Your partner for SEO and digital marketing",
  canonical = Astro.url.href,
  image,
  type = 'website',
  publishDate,
  modifiedDate,
  author,
  article,
  breadcrumbs,
  noindex = false,
  nofollow = false,
  faqs
} = Astro.props;

// With trailingSlash set to 'always', canonical can simply use current URL
const finalCanonical = canonical;
const isHome = Astro.url.pathname === '/';

---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <!-- Mobile-specific optimization -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <!-- Force consistent light color scheme across browsers -->
    <meta name="color-scheme" content="light" />
    <meta name="supported-color-schemes" content="light" />
    <meta name="google-site-verification" content="ChxTytE2xXPqUiIN7QDHvdQD0Z3JKf6vpa1DcVKTRR4" />
    <!-- Title tag handled by SEO component to prevent duplicates -->
    
    <!-- SEO Component with Schema, Canonical URLs, and Meta Tags -->
    <SEO
      title={title}
      description={description}
      canonical={finalCanonical}
      image={image}
      type={type}
      publishDate={publishDate}
      modifiedDate={modifiedDate}
      author={author}
      article={article}
      breadcrumbs={breadcrumbs}
      noindex={noindex}
      nofollow={nofollow}
      includeWebsite={isHome}
      includeOrganization={isHome}
      includeLocalBusiness={false}
      includeGenericFAQ={false}
      faqs={faqs}
      includeReviews={true}
    />
    
    <slot name="head" />
    
    <!-- DNS prefetch for external domains -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    
    <!-- Preconnect to critical third-party domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Preload critical fonts with font-display: swap -->
    <link rel="preload" href="https://fonts.gstatic.com/s/dmsans/v15/rP2Hp2ywxg089UriCZOIHQ.woff2" as="font" type="font/woff2" crossorigin>
    
    <!-- Load only essential font weights (400 and 700) for smaller file size -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&display=swap" rel="stylesheet"></noscript>
    
    <!-- FontAwesome 5.15.4 - Known stable version -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer">
    
    <!-- FontAwesome CSS fix -->
    <style>
      /* Force FontAwesome to work properly */
      [class^="fa-"], [class*=" fa-"], .fas, .far, .fab, .fal, .fad {
        font-family: "Font Awesome 5 Free", "Font Awesome 5 Pro", "Font Awesome 5 Brands", "FontAwesome" !important;
        font-style: normal !important;
        font-variant: normal !important;
        text-rendering: auto !important;
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
      }
      
      .fas { font-weight: 900 !important; }
      .far { font-weight: 400 !important; }
      .fab { 
        font-family: "Font Awesome 5 Brands", "FontAwesome" !important;
        font-weight: 400 !important;
      }
    </style>
    
    <!-- Preload hero image -->
    <link rel="preload" as="image" href="/images/Hero-SEO-Agency-In-The-Philippines.webp" fetchpriority="high">

    <!-- Mobile Performance Optimization Script -->
    <script>
      // Disable hover effects on mobile for better performance
      if ('ontouchstart' in window) {
        document.documentElement.classList.add('touch-device');
      }

      // Optimize scroll performance
      if ('IntersectionObserver' in window) {
        const lazyImages = document.querySelectorAll('img[loading="lazy"]');
        const imageObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              if (img.dataset.src) {
                img.src = img.dataset.src;
                imageObserver.unobserve(img);
              }
            }
          });
        });
        lazyImages.forEach(img => imageObserver.observe(img));
      }
    </script>

    <!-- Prevent layout shifts -->
    <style>
      /* Prevent CLS (Cumulative Layout Shift) */
      img:not([width]):not([height]) {
        aspect-ratio: attr(width) / attr(height);
      }

      /* Disable hover effects on touch devices */
      .touch-device *:hover {
        transition: none !important;
      }

      /* Optimize mobile fonts */
      @media (max-width: 768px) {
        * {
          text-size-adjust: 100%;
          -webkit-text-size-adjust: 100%;
        }
      }
    </style>
    
    <!-- Updated Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favcon/bright-forge-favcon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favcon/bright-forge-favcon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favcon/bright-forge-favcon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#f97316">
    <meta name="msapplication-TileColor" content="#f97316">
    <meta name="msapplication-TileImage" content="/images/favcon/bright-forge-favcon.png">
    
    <!-- Additional SEO Meta Tags -->
    <meta name="format-detection" content="telephone=no">
    <meta name="geo.region" content="PH-00">
    <meta name="geo.placename" content="Quezon City, Philippines">
    <meta name="geo.position" content="14.6760;121.0437">
    <meta name="ICBM" content="14.6760, 121.0437">
    <meta name="language" content="en-PH">
    <meta name="distribution" content="global">
    <meta name="rating" content="general">
    
    <!-- Business Information -->
    <meta name="business:contact_data:street_address" content="Kathleen Place 4, Block 16, Lot 37, Armani Street">
    <meta name="business:contact_data:locality" content="Novaliches">
    <meta name="business:contact_data:region" content="Quezon City">
    <meta name="business:contact_data:postal_code" content="1123">
    <meta name="business:contact_data:country_name" content="Philippines">
    <meta name="business:contact_data:email" content="seo@brightforgeseo.com">
    <meta name="business:contact_data:phone_number" content="+63-969-620-6182">
    
    <!-- CSS is already imported above and will be processed by Astro -->
  </head>
  <body class="font-dm-sans text-brand-dark bg-[#f8fafc] min-h-screen flex flex-col">
    <slot name="header" />
    <main class="flex-1">
      <slot />
    </main>
    <slot name="footer" />
    
    <!-- Load non-critical JavaScript asynchronously -->
    <script defer>
      // Performance optimization: Load analytics and other non-critical scripts
      window.addEventListener('load', function() {
        // SimpleAnalytics script
        let sa = document.createElement('script');
        sa.async = true;
        sa.src = 'https://scripts.simpleanalyticscdn.com/latest.js';
        document.head.appendChild(sa);
        
        // No-JS fallback for SimpleAnalytics
        let noscript = document.createElement('noscript');
        let img = document.createElement('img');
        img.src = 'https://queue.simpleanalyticscdn.com/noscript.gif';
        img.alt = '';
        img.referrerPolicy = 'no-referrer-when-downgrade';
        noscript.appendChild(img);
        document.body.appendChild(noscript);
        
        console.log('Page fully loaded - analytics loaded');
      });
      
      // Optimize images with lazy loading
      if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              img.src = img.dataset.src;
              img.classList.remove('lazy');
              imageObserver.unobserve(img);
            }
          });
        });
        
        document.querySelectorAll('img[data-src]').forEach(img => {
          imageObserver.observe(img);
        });
      }
    </script>
  </body>
<style is:global>
  /* Final fix: Force html background to dark to hide any rendering gap */
  html {
    background-color: #1a1a1a; /* Footer dark color */
  }

  body {
    background-color: #f8fafc !important; /* Site grey */
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    margin: 0;
    padding: 0;
  }

  main {
    flex-grow: 1;
  }
</style>
</html>
