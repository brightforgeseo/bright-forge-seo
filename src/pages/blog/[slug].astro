---
import ArticleTemplate from '../../components/ArticleTemplate.astro';
import LegacyHeader from '../../components/LegacyHeader.astro';
import Footer from '../../components/Footer.astro';
import { getBlogPostBySlug, getAllBlogPosts } from '../../lib/contentful';

export async function getStaticPaths() {
  const posts = await getAllBlogPosts();
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

import { documentToHtmlString } from '@contentful/rich-text-html-renderer';
import { BLOCKS } from '@contentful/rich-text-types';
import { JSDOM } from 'jsdom';

// Get the slug from the URL
const { slug } = Astro.params;

// Fetch the blog post data
const post = await getBlogPostBySlug(slug);

// Handle 404 if the post is not found
if (!post) {
  return Astro.redirect('/404');
}

// Process the content if it exists
let htmlContent = '';
let tableOfContents = [];

if (post.content) {
  // Custom renderer to handle embedded InfographicBlock entries
  const renderOptions = {
    renderNode: {
      [BLOCKS.EMBEDDED_ENTRY]: (node) => {
        const entry = node.data.target;
        
        // Check if this is an InfographicBlock
        if (entry?.sys?.contentType?.sys?.id === 'infographicBlock') {
          const type = entry.fields?.infographicType || 'tabs';
          const title = entry.fields?.title || '';
          const params = entry.fields?.parameters || {};
          
          // Build shortcode string from the embedded entry
          let shortcodeParams = [`type="${type}"`, `title="${title}"`];
          
          // Add any additional parameters from the JSON object
          if (typeof params === 'object' && params !== null) {
            Object.entries(params).forEach(([key, value]) => {
              if (key !== 'type' && key !== 'title') {
                shortcodeParams.push(`${key}="${value}"`);
              }

  // Interactive E-E-A-T Radar (Experience, Expertise, Authoritativeness, Trust)
  // Accessible with keyboard, animated polygon, sliders, presets, and live announcements
  function generateEEATRadarHTML({
    title = 'E-E-A-T Scorecard',
    experience = 70,
    expertise = 80,
    authoritativeness = 65,
    trust = 75
  } = {}) {
    // Coerce to [0,100]
    function clamp01(v){ const n = Number(v); return Math.max(0, Math.min(100, isNaN(n) ? 0 : n)); }
    const exp = clamp01(experience);
    const exs = clamp01(expertise);
    const auth = clamp01(authoritativeness);
    const trst = clamp01(trust);
    return `
<section class="max-w-5xl mx-auto px-4" aria-labelledby="eeat-title">
  <h2 id="eeat-title" class="text-center text-2xl md:text-3xl font-bold text-gray-900 mb-6 md:mb-8">${escapeHtml(decodeEntities(title))}</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 items-center">
    <!-- Chart Card -->
    <div class="bg-white rounded-2xl ring-1 ring-red-100 shadow-[0_18px_36px_-18px_rgba(239,68,68,0.25)] p-4 md:p-6" data-widget="eeat-radar" data-experience="${exp}" data-expertise="${exs}" data-authoritativeness="${auth}" data-trust="${trst}">
      <figure>
        <svg class="w-full h-[320px] md:h-[360px]" viewBox="0 0 320 320" role="img" aria-labelledby="eeat-graphic-title eeat-graphic-desc">
          <title id="eeat-graphic-title">E-E-A-T radar chart</title>
          <desc id="eeat-graphic-desc">An interactive radar showing scores for Experience, Expertise, Authoritativeness, and Trust</desc>
          <!-- Grid and axes will be drawn by script for clarity -->
          <g data-grid></g>
          <g data-axes></g>
          <polygon data-polygon fill="rgba(239,68,68,0.15)" stroke="#ef4444" stroke-width="2" points=""/>
          <g data-dots fill="#ef4444"></g>
          <g data-labels class="text-[12px] fill-gray-700"></g>
        </svg>
        <figcaption class="sr-only">Use the sliders to adjust each dimension and see the polygon update in real-time.</figcaption>
      </figure>
      <div class="sr-only" aria-live="polite" data-announcer></div>
    </div>

    <!-- Controls -->
    <div class="bg-white rounded-2xl ring-1 ring-gray-100 p-4 md:p-6">
      <div role="group" aria-labelledby="eeat-sliders-title">
        <h3 id="eeat-sliders-title" class="text-lg font-semibold text-gray-900 mb-4">Adjust Scores</h3>
        <div class="space-y-4">
          <label class="block">
            <span class="flex items-center justify-between text-sm font-medium text-gray-700 mb-1"><span>Experience</span><output data-out="experience" class="text-gray-900 font-semibold">${exp}</output></span>
            <input type="range" min="0" max="100" step="1" value="${exp}" data-key="experience" class="w-full accent-red-500" aria-label="Experience score">
          </label>
          <label class="block">
            <span class="flex items-center justify-between text-sm font-medium text-gray-700 mb-1"><span>Expertise</span><output data-out="expertise" class="text-gray-900 font-semibold">${exs}</output></span>
            <input type="range" min="0" max="100" step="1" value="${exs}" data-key="expertise" class="w-full accent-red-500" aria-label="Expertise score">
          </label>
          <label class="block">
            <span class="flex items-center justify-between text-sm font-medium text-gray-700 mb-1"><span>Authoritativeness</span><output data-out="authoritativeness" class="text-gray-900 font-semibold">${auth}</output></span>
            <input type="range" min="0" max="100" step="1" value="${auth}" data-key="authoritativeness" class="w-full accent-red-500" aria-label="Authoritativeness score">
          </label>
          <label class="block">
            <span class="flex items-center justify-between text-sm font-medium text-gray-700 mb-1"><span>Trust</span><output data-out="trust" class="text-gray-900 font-semibold">${trst}</output></span>
            <input type="range" min="0" max="100" step="1" value="${trst}" data-key="trust" class="w-full accent-red-500" aria-label="Trust score">
          </label>
        </div>
      </div>
      <div class="mt-5 flex flex-wrap gap-2">
        <button class="px-3 py-1.5 text-sm rounded-full bg-gray-100 hover:bg-gray-200 text-gray-800 transition" data-action="randomize">Randomize</button>
        <button class="px-3 py-1.5 text-sm rounded-full bg-gray-100 hover:bg-gray-200 text-gray-800 transition" data-action="reset">Reset</button>
        <button class="px-3 py-1.5 text-sm rounded-full bg-white border border-gray-200 hover:border-red-300 hover:text-red-700 transition" data-preset="new">Preset: New Site</button>
        <button class="px-3 py-1.5 text-sm rounded-full bg-white border border-gray-200 hover:border-red-300 hover:text-red-700 transition" data-preset="brand">Preset: Trusted Brand</button>
      </div>
    </div>
  </div>
</section>
<script>(function(){
  var root = document.currentScript.previousElementSibling;
  var widget = root.querySelector('[data-widget="eeat-radar"]');
  // Fallback if HTML encoding clashes
  if(!widget){ widget = root.querySelector('[data-widget=eeat-radar]'); }
  if(!widget) return;

  var svg = widget.querySelector('svg');
  var gGrid = svg.querySelector('[data-grid]');
  var gAxes = svg.querySelector('[data-axes]');
  var gDots = svg.querySelector('[data-dots]');
  var gLabels = svg.querySelector('[data-labels]');
  var polygon = svg.querySelector('[data-polygon]');
  var announcer = widget.querySelector('[data-announcer]');
  var sliders = root.querySelectorAll('input[type=range][data-key]');
  var outs = root.querySelectorAll('output[data-out]');

  var cx = 160, cy = 160, rMax = 120;
  var axes = [
    { key: 'experience', label: 'Experience', angle: -90 },
    { key: 'expertise', label: 'Expertise', angle:   0 },
    { key: 'authoritativeness', label: 'Authoritativeness', angle: 90 },
    { key: 'trust', label: 'Trust', angle: 180 }
  ];

  function clamp(v){ v = Number(v); return Math.max(0, Math.min(100, isNaN(v)?0:v)); }
  function polar(val, angle){ var rad = (angle*Math.PI)/180; var r = (clamp(val)/100)*rMax; return [cx + r*Math.cos(rad), cy + -r*Math.sin(rad)]; }
  function fmt(p){ return p.map(function(n){ return Math.round(n*10)/10; }).join(','); }

  // Draw grid rings and axis lines + labels
  (function drawOnce(){
    var steps = [20,40,60,80,100];
    steps.forEach(function(pct){
      var pts = axes.map(function(a){ return polar(pct, a.angle); });
      var poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
      poly.setAttribute('fill','none');
      poly.setAttribute('stroke','#e5e7eb'); // gray-200
      poly.setAttribute('points', pts.map(function(pt){return fmt(pt);} ).join(' '));
      gGrid.appendChild(poly);
    });
    axes.forEach(function(a){
      var end = polar(100, a.angle);
      var ln = document.createElementNS('http://www.w3.org/2000/svg','line');
      ln.setAttribute('x1', cx); ln.setAttribute('y1', cy); ln.setAttribute('x2', end[0]); ln.setAttribute('y2', end[1]);
      ln.setAttribute('stroke','#e5e7eb');
      gAxes.appendChild(ln);

      var lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      var off = 12;
      lbl.setAttribute('x', end[0] + (a.angle===0?8:(a.angle===180?-8:0)));
      lbl.setAttribute('y', end[1] + (a.angle===-90?-8:(a.angle===90?18:4)));
      lbl.setAttribute('text-anchor', (a.angle===180)?'end':(a.angle===0?'start':'middle'));
      lbl.textContent = a.label;
      gLabels.appendChild(lbl);
    });
    axes.forEach(function(a){
      var dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
      dot.setAttribute('r','4');
      dot.setAttribute('data-dot', a.key);
      gDots.appendChild(dot);
    });
  })();

  var prefersReduced = false;
  try{ prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches; }catch(_e){}

  function getValues(){
    var v = {};
    axes.forEach(function(a){ v[a.key] = clamp(widget.getAttribute('data-'+a.key)); });
    sliders.forEach(function(sl){ var k=sl.getAttribute('data-key'); v[k]=clamp(sl.value); });
    return v;
  }

  function setOutputs(v){
    outs.forEach(function(o){ var k=o.getAttribute('data-out'); if(k in v) o.textContent = v[k]; });
  }

  function update(v){
    var pts = axes.map(function(a){ return polar(v[a.key], a.angle); });
    polygon.setAttribute('points', pts.map(function(p){ return fmt(p); }).join(' '));
    axes.forEach(function(a,i){
      var dot = gDots.querySelector('[data-dot="'+a.key+'"]');
      if(dot){ dot.setAttribute('cx', pts[i][0]); dot.setAttribute('cy', pts[i][1]); }
    });
    if(announcer){ announcer.textContent = 'Scores updated: Experience '+v.experience+', Expertise '+v.expertise+', Authoritativeness '+v.authoritativeness+', Trust '+v.trust+'.'; }
  }

  function animateTo(target){
    if(prefersReduced){ update(target); return; }
    var start = getValues();
    var t0 = performance.now();
    var dur = 400;
    function step(now){
      var k = Math.min(1, (now - t0) / dur);
      var ease = k<0.5 ? 2*k*k : -1 + (4 - 2*k) * k;
      var cur = {};
      axes.forEach(function(a){ cur[a.key] = Math.round(start[a.key] + (target[a.key]-start[a.key]) * ease); });
      setOutputs(cur); update(cur);
      if(k<1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  function current(){ return getValues(); }

  // Wire sliders
  sliders.forEach(function(sl){ sl.addEventListener('input', function(){ var v=current(); v[sl.getAttribute('data-key')] = clamp(sl.value); setOutputs(v); update(v); }); });

  // Buttons
  root.addEventListener('click', function(e){
    var btn = e.target.closest('[data-action],[data-preset]');
    if(!btn) return;
    if(btn.hasAttribute('data-action')){
      var a = btn.getAttribute('data-action');
      if(a==='reset'){
        var v0 = { experience: clamp(widget.getAttribute('data-experience')), expertise: clamp(widget.getAttribute('data-expertise')), authoritativeness: clamp(widget.getAttribute('data-authoritativeness')), trust: clamp(widget.getAttribute('data-trust')) };
        setOutputs(v0); animateTo(v0);
      } else if(a==='randomize'){
        var v1 = { experience: Math.round(60+Math.random()*40), expertise: Math.round(60+Math.random()*40), authoritativeness: Math.round(50+Math.random()*50), trust: Math.round(60+Math.random()*40) };
        setOutputs(v1); animateTo(v1);
      }
    } else if(btn.hasAttribute('data-preset')){
      var p = btn.getAttribute('data-preset');
      var v;
      if(p==='new') v = { experience: 40, expertise: 55, authoritativeness: 35, trust: 45 };
      else if(p==='brand') v = { experience: 75, expertise: 80, authoritativeness: 85, trust: 90 };
      if(v){ setOutputs(v); animateTo(v); }
    }
  });

  // Initial render
  var init = { experience: clamp(widget.getAttribute('data-experience')), expertise: clamp(widget.getAttribute('data-expertise')), authoritativeness: clamp(widget.getAttribute('data-authoritativeness')), trust: clamp(widget.getAttribute('data-trust')) };
  setOutputs(init); update(init);
})();</script>`;
  }
            });
          }
          
          // Return the shortcode that will be processed by our existing shortcode system
          return `[[INFOGRAPHIC ${shortcodeParams.join(' ')}]]`;
        }
        
        // For other embedded entries, return empty string or default handling
        return '';
      }
    }
  };
  
  // Convert rich text to HTML with custom renderer
  htmlContent = documentToHtmlString(post.content, renderOptions);
  
  // Replace inline shortcodes like [[INFOGRAPHIC type=...]] with interactive HTML we control
  // Force rebuild: timestamp 13:45
  function decodeEntities(s=''){
    return String(s)
      .replace(/&quot;/g, '"')
      .replace(/&apos;/g, "'")
      .replace(/&ldquo;|&rdquo;/g, '"')
      .replace(/&lsquo;|&rsquo;/g, "'")
      .replace(/&amp;/g, '&')
      .replace(/&lt;/g, '<')
      .replace(/&gt;/g, '>');
  }

  function generateAiBalanceHTML(title = 'AI in Marketing: The Balancing Act') {
    return `
<section class="max-w-4xl mx-auto px-4" aria-labelledby="infographic-title">
  <h3 id="infographic-title" class="text-xl font-semibold text-gray-800 mb-6 text-center">${escapeHtml(decodeEntities(title))}</h3>
  <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-5 sm:p-6">
    <div class="space-y-5">
      <div class="grid grid-cols-1 sm:grid-cols-5 gap-3 items-center">
        <div class="sm:col-span-2 text-sm font-medium text-gray-700">Pattern Recognition (AI)</div>
        <div class="sm:col-span-3">
          <div class="h-3 w-full bg-gray-100 rounded-full overflow-hidden">
            <div class="h-full rounded-full transition-all duration-500 will-change-transform" style="width: 85%; background: #4285F4" data-target-width="85"></div>
          </div>
          <div class="mt-1 text-xs text-gray-500"><span class="value">85</span>%</div>
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-5 gap-3 items-center">
        <div class="sm:col-span-2 text-sm font-medium text-gray-700">Strategic Judgment (Human)</div>
        <div class="sm:col-span-3">
          <div class="h-3 w-full bg-gray-100 rounded-full overflow-hidden">
            <div class="h-full rounded-full transition-all duration-500 will-change-transform" style="width: 90%; background: #FF6B35" data-target-width="90"></div>
          </div>
          <div class="mt-1 text-xs text-gray-500"><span class="value">90</span>%</div>
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-5 gap-3 items-center">
        <div class="sm:col-span-2 text-sm font-medium text-gray-700">Scale & Speed (AI)</div>
        <div class="sm:col-span-3">
          <div class="h-3 w-full bg-gray-100 rounded-full overflow-hidden">
            <div class="h-full rounded-full transition-all duration-500 will-change-transform" style="width: 95%; background: #6AB7FF" data-target-width="95"></div>
          </div>
          <div class="mt-1 text-xs text-gray-500"><span class="value">95</span>%</div>
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-5 gap-3 items-center">
        <div class="sm:col-span-2 text-sm font-medium text-gray-700">Context & Empathy (Human)</div>
        <div class="sm:col-span-3">
          <div class="h-3 w-full bg-gray-100 rounded-full overflow-hidden">
            <div class="h-full rounded-full transition-all duration-500 will-change-transform" style="width: 88%; background: #FF4438" data-target-width="88"></div>
          </div>
          <div class="mt-1 text-xs text-gray-500"><span class="value">88</span>%</div>
        </div>
      </div>
    </div>
    <div class="mt-6 flex flex-wrap gap-2 justify-center">
      <button class="px-3 py-1.5 text-xs rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 transition" data-action="randomize">Randomize</button>
      <button class="px-3 py-1.5 text-xs rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 transition" data-action="reset">Reset</button>
    </div>
  </div>
</section>
<script>(function(){
  var root = document.currentScript.previousElementSibling;
  var bars = root.querySelectorAll('[data-target-width]');
  var initial = Array.prototype.map.call(bars, function(b){ return Number(b.getAttribute('data-target-width')); });
  var valueEls = root.querySelectorAll('.value');
  function setValues(values){ values.forEach(function(v,i){ bars[i].style.width = v + '%'; valueEls[i].textContent = v; }); }
  root.addEventListener('click', function(e){ var btn = e.target.closest('button[data-action]'); if(!btn) return; var a=btn.getAttribute('data-action'); if(a==='randomize'){ var next=initial.map(function(v){ return Math.max(60, Math.min(100, Math.round(v + (Math.random()*20-10))))}); setValues(next);} if(a==='reset'){ setValues(initial);} });
  var obs=new IntersectionObserver(function(entries){ entries.forEach(function(en){ if(en.isIntersecting){ bars.forEach(function(bar,i){ bar.style.width='0%'; requestAnimationFrame(function(){ requestAnimationFrame(function(){ bar.style.width = initial[i] + '%'; });});}); obs.disconnect(); } }); },{threshold:0.2});
  obs.observe(root);
})();</script>`;
  }
  function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  function generateProsConsHTML({ title = 'Pros and Cons', pros = '', cons = '' } = {}) {
    const prosList = String(pros).split(';').map(s => decodeEntities(s).trim()).filter(Boolean);
    const consList = String(cons).split(';').map(s => decodeEntities(s).trim()).filter(Boolean);
    return `
<section class="max-w-4xl mx-auto px-4">
  <h3 class="text-xl font-semibold text-gray-800 mb-6 text-center">${escapeHtml(decodeEntities(title))}</h3>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="rounded-xl border border-green-200 bg-white p-5 shadow-[0_10px_30px_-10px_rgba(16,185,129,0.25)]">
      <h4 class="font-bold text-green-700 mb-3">Pros</h4>
      <ul class="list-disc ml-5 space-y-2 text-gray-800">${prosList.map(li => `<li>${escapeHtml(li)}</li>`).join('')}</ul>
    </div>
    <div class="rounded-xl border border-red-200 bg-white p-5 shadow-[0_10px_30px_-10px_rgba(239,68,68,0.25)]">
      <h4 class="font-bold text-red-700 mb-3">Cons</h4>
      <ul class="list-disc ml-5 space-y-2 text-gray-800">${consList.map(li => `<li>${escapeHtml(li)}</li>`).join('')}</ul>
    </div>
  </div>
</section>`;
  }

  function generateBarsHTML({ title = 'AI vs Human Strengths', items = '' } = {}) {
    const parsed = String(items)
      .split(';')
      .map(s => s.trim())
      .filter(Boolean)
      .map(row => {
        const [label, value, color] = row.split(':');
        const v = Math.max(0, Math.min(100, Number(value || 0)));
        const col = /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(String(color||'')) ? color : '#4285F4';
        return { label: decodeEntities(label || 'Item'), value: v, color: col };
      });
    const bars = parsed.map(item => `
      <div class="grid grid-cols-1 sm:grid-cols-5 gap-3 items-center">
        <div class="sm:col-span-2 text-sm font-medium text-gray-700">${escapeHtml(item.label)}</div>
        <div class="sm:col-span-3">
          <div class="h-3 w-full bg-gray-100 rounded-full overflow-hidden">
            <div class="h-full rounded-full transition-all duration-500 will-change-transform" style="width: ${item.value}% ; background: ${item.color}" data-target-width="${item.value}"></div>
          </div>
          <div class="mt-1 text-xs text-gray-500"><span class="value">${item.value}</span>%</div>
        </div>
      </div>`).join('');
    return `
<section class="max-w-4xl mx-auto px-4" aria-labelledby="bars-title">
  <h3 id="bars-title" class="text-xl font-semibold text-gray-800 mb-6 text-center">${escapeHtml(decodeEntities(title))}</h3>
  <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-5 sm:p-6">
    <div class="space-y-5">${bars}</div>
    <div class="mt-6 flex flex-wrap gap-2 justify-center">
      <button class="px-3 py-1.5 text-xs rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 transition" data-action="randomize">Randomize</button>
      <button class="px-3 py-1.5 text-xs rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 transition" data-action="reset">Reset</button>
    </div>
  </div>
</section>
<script>(function(){
  var root = document.currentScript.previousElementSibling;
  var bars = root.querySelectorAll('[data-target-width]');
  var initial = Array.prototype.map.call(bars, function(b){ return Number(b.getAttribute('data-target-width')); });
  var valueEls = root.querySelectorAll('.value');
  function setValues(values){ values.forEach(function(v,i){ bars[i].style.width = v + '%'; valueEls[i].textContent = v; }); }
  root.addEventListener('click', function(e){ var btn = e.target.closest('button[data-action]'); if(!btn) return; var a=btn.getAttribute('data-action'); if(a==='randomize'){ var next=initial.map(function(v){ return Math.max(0, Math.min(100, Math.round(v + (Math.random()*20-10))))}); setValues(next);} if(a==='reset'){ setValues(initial);} });
  var obs=new IntersectionObserver(function(entries){ entries.forEach(function(en){ if(en.isIntersecting){ bars.forEach(function(bar,i){ bar.style.width='0%'; requestAnimationFrame(function(){ requestAnimationFrame(function(){ bar.style.width = initial[i] + '%'; });});}); obs.disconnect(); } }); },{threshold:0.2});
  obs.observe(root);
})();</script>`;
  }

  // Parse key=value pairs, allowing straight and smart quotes, and clean stray entity quotes
  function parseParams(paramStr = '') {
    const params = {};
    const re = /(\w+)=\s*("[^"]*"|“[^”]*”|'[^']*'|‘[^’]*’|[^\s\]]+)/g;
    const stripWrappingQuotes = (v) => {
      if (!v) return v;
      v = v.trim();
      const pairs = [
        ['"','"'],
        ["'","'"],
        ['“','”'],
        ['‘','’'],
      ];
      for (const [l, r] of pairs) {
        if (v.startsWith(l) && v.endsWith(r)) return v.slice(1, -1);
      }
      // Also strip common HTML entity quotes if present at edges
      v = v.replace(/^&quot;|^&ldquo;|^&lsquo;/, '');
      v = v.replace(/&quot;$|&rdquo;$|&rsquo;$/, '');
      return v;
    };
    let m;
    while ((m = re.exec(paramStr)) !== null) {
      const key = m[1];
      let val = stripWrappingQuotes(m[2]);
      params[key] = val;
    }
    return params;
  }

  function generateTabsHTML({ title = 'AI in Marketing: The Balancing Act' } = {}) {
    return `
<section class="max-w-7xl mx-auto px-4">
  <h2 class="text-center text-2xl md:text-3xl font-bold text-gray-900 mb-6 md:mb-8">${escapeHtml(decodeEntities(title))}</h2>

  <!-- Pill Tab Navigation -->
  <div role="tablist" aria-label="Infographic topics" aria-orientation="horizontal" class="flex flex-wrap justify-center gap-3 md:gap-4 overflow-x-auto md:overflow-visible pb-2 md:pb-0 mb-8 no-scrollbar">
    <button id="tab-bright" role="tab" aria-selected="true" aria-controls="panel-bright" data-tab="bright"
      tabindex="0" class="tab-trigger inline-flex items-center gap-2 whitespace-nowrap rounded-full border px-4 py-2 text-sm md:text-base transition-all duration-200
             bg-white border-red-200 text-red-700 shadow-[0_6px_18px_-8px_rgba(239,68,68,0.35)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-400 focus-visible:ring-offset-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
      <span class="font-semibold">The Bright Side</span>
    </button>
    <button id="tab-dark" role="tab" aria-selected="false" aria-controls="panel-dark" data-tab="dark" tabindex="-1"
      class="tab-trigger inline-flex items-center gap-2 whitespace-nowrap rounded-full border px-4 py-2 text-sm md:text-base transition-all duration-200
             bg-white border-gray-200 text-gray-700 hover:border-red-300 hover:text-red-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-400 focus-visible:ring-offset-2">
      <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
      <span class="font-semibold">The Dark Side</span>
    </button>
    <button id="tab-eeat" role="tab" aria-selected="false" aria-controls="panel-eeat" data-tab="eeat" tabindex="-1"
      class="tab-trigger inline-flex items-center gap-2 whitespace-nowrap rounded-full border px-4 py-2 text-sm md:text-base transition-all duration-200
             bg-white border-gray-200 text-gray-700 hover:border-red-300 hover:text-red-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-400 focus-visible:ring-offset-2">
      <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
      <span class="font-semibold">The E-E-A-T Framework</span>
    </button>
    <button id="tab-future" role="tab" aria-selected="false" aria-controls="panel-future" data-tab="future" tabindex="-1"
      class="tab-trigger inline-flex items-center gap-2 whitespace-nowrap rounded-full border px-4 py-2 text-sm md:text-base transition-all duration-200
             bg-white border-gray-200 text-gray-700 hover:border-red-300 hover:text-red-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-400 focus-visible:ring-offset-2">
      <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
      <span class="font-semibold">Future-Proofing</span>
    </button>
  </div>

  <!-- Content Panel -->
  <div class="rounded-2xl ring-1 ring-red-100 bg-white shadow-[0_18px_36px_-18px_rgba(239,68,68,0.25)]">
    <div class="p-6 md:p-8">
      <section id="panel-bright" role="tabpanel" aria-labelledby="tab-bright" tabindex="0" class="tab-panel" data-panel="bright">
        <div class="flex items-center gap-3 mb-4">
          <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
          <h3 class="text-xl font-bold text-gray-900">The Bright Side</h3>
        </div>
        <ul class="space-y-3 text-gray-800 leading-relaxed">
          <li class="flex items-start gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-red-500"></span><span>Efficiency: AI drafts blogs in minutes instead of hours</span></li>
          <li class="flex items-start gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-red-500"></span><span>Scalability: Create content at a fraction of the cost</span></li>
          <li class="flex items-start gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-red-500"></span><span>Data Power: Analyse competitor strategies with ease</span></li>
        </ul>
      </section>

      <section id="panel-dark" role="tabpanel" aria-labelledby="tab-dark" tabindex="0" class="tab-panel hidden" data-panel="dark">
        <div class="flex items-center gap-3 mb-4">
          <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
          <h3 class="text-xl font-bold text-gray-900">The Dark Side</h3>
        </div>
        <ul class="space-y-3 text-gray-800 leading-relaxed">
          <li class="flex items-start gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-red-500"></span><span>Hallucinations: AI can state incorrect facts confidently</span></li>
          <li class="flex items-start gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-red-500"></span><span>Lack of Soul: Content often lacks originality and emotion</span></li>
          <li class="flex items-start gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-red-500"></span><span>Risk: Can damage brand credibility if unchecked</span></li>
        </ul>
      </section>

      <section id="panel-eeat" role="tabpanel" aria-labelledby="tab-eeat" tabindex="0" class="tab-panel hidden" data-panel="eeat">
        <div class="flex items-center gap-3 mb-4">
          <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
          <h3 class="text-xl font-bold text-gray-900">The E-E-A-T Framework</h3>
        </div>
        <ul class="space-y-3 text-gray-800 leading-relaxed">
          <li class="flex items-start gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-red-500"></span><span>Experience: First-hand knowledge adds real value</span></li>
          <li class="flex items-start gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-red-500"></span><span>Expertise: Demonstrates authority in your field</span></li>
          <li class="flex items-start gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-red-500"></span><span>Authoritativeness: Builds recognition and trust</span></li>
          <li class="flex items-start gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-red-500"></span><span>Trustworthiness: Ensures content accuracy and honesty</span></li>
        </ul>
      </section>

      <section id="panel-future" role="tabpanel" aria-labelledby="tab-future" tabindex="0" class="tab-panel hidden" data-panel="future">
        <div class="flex items-center gap-3 mb-4">
          <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
          <h3 class="text-xl font-bold text-gray-900">Future-Proofing</h3>
        </div>
        <ul class="space-y-3 text-gray-800 leading-relaxed">
          <li class="flex items-start gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-red-500"></span><span>Google SGE: Optimise for AI-powered search answers</span></li>
          <li class="flex items-start gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-red-500"></span><span>Hyper-Personalisation: Tailor content to user behaviour</span></li>
          <li class="flex items-start gap-3"><span class="mt-2 h-2 w-2 rounded-full bg-red-500"></span><span>Balance: Use AI to amplify—not replace—human expertise</span></li>
        </ul>
      </section>
    </div>
  </div>
</section>
<script>(function(){
  var root = document.currentScript.previousElementSibling;
  var triggers = root.querySelectorAll('.tab-trigger');
  var panels = root.querySelectorAll('.tab-panel');

  function activate(target){
    triggers.forEach(function(btn){
      var isActive = btn.getAttribute('data-tab') === target;
      btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      btn.setAttribute('tabindex', isActive ? '0' : '-1');
      btn.classList.toggle('border-red-200', isActive);
      btn.classList.toggle('text-red-700', isActive);
      btn.classList.toggle('shadow-[0_6px_18px_-8px_rgba(239,68,68,0.35)]', isActive);
      btn.classList.toggle('border-gray-200', !isActive);
      btn.classList.toggle('text-gray-700', !isActive);
    });

    panels.forEach(function(panel){
      var show = panel.getAttribute('data-panel') === target;
      panel.classList.toggle('hidden', !show);
    });
  }

  // Click
  triggers.forEach(function(btn){
    btn.addEventListener('click', function(){ activate(btn.getAttribute('data-tab')); });
    // Keyboard: left/right to switch
    btn.addEventListener('keydown', function(e){
      var list = Array.prototype.slice.call(triggers);
      var i = list.indexOf(btn);
      var nextIdx = null;
      if(e.key === 'ArrowRight') nextIdx = (i+1) % list.length;
      else if(e.key === 'ArrowLeft') nextIdx = (i-1+list.length) % list.length;
      else if(e.key === 'Home') nextIdx = 0;
      else if(e.key === 'End') nextIdx = list.length - 1;
      else return;
      e.preventDefault();
      list[nextIdx].focus();
      activate(list[nextIdx].getAttribute('data-tab'));
    });
  });

  // Initial
  activate('bright');
})();</script>`;
  }

  function replaceShortcodes(inputHtml) {
    const re = /\[\[INFOGRAPHIC(?:\s+([^\]]+))?\]\]/g;
    return inputHtml.replace(re, (_match, paramStr) => {
      const params = parseParams(paramStr || '');
      let type = (params.type || 'tabs').toLowerCase();
      const eeatTitle = String(params.title || '').toUpperCase();
      // If it's an EEAT infographic and forceTabs is not true, upgrade to radar
      if ((type === 'tabs' || type === 'eeat' || type === 'eeat-radar') && /E-?E-?A-?T/.test(eeatTitle) && String(params.forceTabs).toLowerCase() !== 'true') {
        type = 'eeat-radar';
      }
      if (type === 'eeat-radar') return generateEEATRadarHTML(params);
      if (type === 'tabs') return generateTabsHTML(params);
      if (type === 'ai-balance') return generateAiBalanceHTML(params.title);
      if (type === 'pros-cons') return generateProsConsHTML(params);
      if (type === 'bars') return generateBarsHTML(params);
      // fallback
      return generateTabsHTML(params);
    })
    // Also allow HTML comment marker as a basic fallback
    .replace(/<!--\s*INFOGRAPHIC\s*-->/g, generateTabsHTML());
  }
  
  htmlContent = replaceShortcodes(htmlContent);
  
  // Generate table of contents from HTML headings
  const dom = new JSDOM(htmlContent);
  const headings = [...dom.window.document.querySelectorAll('h2, h3')];
  
  tableOfContents = headings.map(heading => {
    const text = heading.textContent;
    const id = text
      .toLowerCase()
      .replace(/[^\w\s]/g, '')
      .replace(/\s+/g, '-');
    
    // Add ID to the heading in the HTML
    heading.id = id;
    
    return {
      id,
      title: text,
      level: parseInt(heading.tagName.substring(1), 10)
    };
  });
  
  // Update the HTML content with IDs
  htmlContent = dom.window.document.body.innerHTML;
}

// Format the publish date
const formattedDate = post.publishDate ? 
  new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'long', day: 'numeric' }).format(post.publishDate) : 
  '';

// Prepare ArticleTemplate props
const templateProps = {
  title: post.title,
  excerpt: post.excerpt || '',
  author: {
    name: post.author || 'BrightForge Team',
    bio: 'Digital marketing experts specializing in SEO and content strategy.',
    avatar: '',
    linkedin: ''
  },
  publishDate: formattedDate,
  readTime: '5 min read', // You could calculate this based on content length
  category: 'SEO & Marketing',
  tags: post.tags || [],
  featuredImage: post.featuredImage,
  content: htmlContent,
  tableOfContents: tableOfContents,
  showInfographic: post.showInfographic === true
};
---

<ArticleTemplate {...templateProps}>
  <LegacyHeader slot="header" />
  <Footer slot="footer" />
</ArticleTemplate>
